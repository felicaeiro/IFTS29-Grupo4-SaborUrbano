doctype html
html
  head
    link(rel="stylesheet", href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css")
    link(rel="stylesheet", href="/css/styles.css")

    title Pedidos

  body
    header.header
      h2 Pedidos
      div
        span Bienvenido #{usuario}
        form(method="POST", action="/logout")
          button(type="submit") Cerrar sesión

    div.div-btn-pedidos-nuevo-finalizado
      form(method="GET", action="/pedidos/nuevo")
        button.btn-pedidos.btn-nuevo-pedido(type="submit") Nuevo pedido
      
      a(href="/pedidos/finalizados")
        button.btn-pedidos.btn-finalizar Pedidos finalizados


    .ul-pedidos
      each pedido in pedidos
        li.li-pedidos
          p
            strong Fecha:
            | #{new Date(pedido.fecha).toLocaleDateString('es-AR')}
          
          p
            strong Tipo:
            | #{pedido.tipo}
          
          p
            strong Cliente:
            | #{pedido.id_cliente ? pedido.id_cliente.nombre + ' ' + pedido.id_cliente.apellido : 'Sin cliente'}

          p
            strong Productos:
            ul.ul-productos
              each p in pedido.productos
                if p.producto
                  li #{p.cantidad} #{p.producto.nombre} ($#{p.producto.precio})
                else
                  li Producto no encontrado
          
          p
            strong Total:
            | $#{pedido.total}
            

          div.div-btn
            button.btn-pedidos.btn-finalizar(type="button", data-id=pedido._id) Finalizar

            a(href=`/pedidos/editar/${pedido._id}`)
              button.btn-pedidos.btn-editar-pedido.btn-float Editar

            button.btn-pedidos.btn-float(type="button", data-bs-toggle="modal", data-bs-target=`#modalEliminar-${pedido._id}`)
              | Eliminar
            



        div.modal.fade(id=`modalEliminar-${pedido._id}`, tabindex="-1", aria-labelledby=`modalEliminarLabel-${pedido._id}`, aria-hidden="true")
          div.modal-dialog
            div.modal-content
              div.modal-header
                h5.modal-title(id=`modalEliminarLabel-${pedido._id}`) Confirmar eliminación
                button.btn-close(type="button", data-bs-dismiss="modal", aria-label="Close")
              div.modal-body
                | ¿Seguro que deseas eliminar el pedido del cliente 
                strong #{pedido.id_cliente ? pedido.id_cliente.nombre + ' ' + pedido.id_cliente.apellido : 'sin cliente'}
                | ?
              div.modal-footer
                button.btn.btn-secondary(type="button", data-bs-dismiss="modal") Cancelar
                form(action=`/pedidos/${pedido._id}?_method=DELETE`, method="POST", style="display:inline")
                  button.btn.btn-danger(type="submit") Eliminar



    script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js")



//- Ocultar el pedido finalizado de la lista de pedidos
script.
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.btn-finalizar').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const id = e.target.dataset.id;
        try {
          const res = await fetch(`/pedidos/finalizar/${id}`, {
            method: 'PUT'
          });
          const data = await res.json();

          if (res.ok) {
            const li = e.target.closest('li.li-pedidos');
            if (li) li.remove();
          } else {
            alert('Error: ' + data.message);
          }
        } catch (err) {
          alert('Error al conectar con el servidor');
        }
      });
    });
  });




