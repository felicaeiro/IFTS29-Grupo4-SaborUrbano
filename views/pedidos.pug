doctype html
html
  head
    link(rel="stylesheet", href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css")
    link(rel="stylesheet", href="/css/styles.css")

    title Modulo de Pedidos

  body
    header.header
      h2 Modulo de Pedidos
      div
        if usuario === 'admin'
         div.div-menu
          a(href="/inicio").a-inicio Inicio
          a(href="/productos").a-inicio Productos
          a(href="/pedidos").a-inicio Pedidos
          a(href="/clientes").a-inicio Clientes
          a(href="/caja").a-inicio Pagos
          a(href="/informe").a-inicio Informes
          
        span Bienvenido #{usuario}
        form(method="POST", action="/logout")
          button(type="submit") Cerrar sesión

    div.div-btn-pedidos-nuevo-finalizado
      form(method="GET", action="/pedidos/nuevo")
        button.btn-pedidos.btn-nuevo-pedido(type="submit") Nuevo pedido
      
      a(href="/pedidos/finalizados")
        button.btn-pedidos Pedidos finalizados


    .ul-pedidos
      each pedido in pedidos
        li.li-pedidos
          p
            strong Fecha:
            | #{new Date(pedido.fecha).toLocaleDateString('es-AR')}
          
          p
            strong Tipo:
            | #{pedido.tipo}
          
          p
            strong Cliente:
            | #{pedido.id_cliente ? pedido.id_cliente.nombre + ' ' + pedido.id_cliente.apellido : 'Sin cliente'}

          p
            strong Productos:
            ul.ul-productos
              each p in pedido.productos
                if p.producto
                  li #{p.cantidad} #{p.producto.nombre} ($#{p.producto.precio})
                else
                  li Producto no encontrado
          
          p
            strong Total:
            | $#{pedido.total}

            
          div.div-btn
            if pedido.estado === 'pendiente'
              button.btn-pedidos.btn-preparar(type="button", data-id=pedido._id) Preparar

            else if pedido.estado === 'preparando'
              button.btn-pedidos.btn-finalizar(type="button", data-id=pedido._id) Finalizar

            else if pedido.estado === 'finalizado'
              span.estado-finalizado FINALIZADO
          
            a(href=`/pedidos/editar/${pedido._id}`)
              img(src="../images/editar.png", alt="editar")

            img(src="../images/eliminar.png", alt="eliminar" data-bs-toggle="modal", data-bs-target=`#modalEliminar-${pedido._id}`)




        div.modal.fade(id=`modalEliminar-${pedido._id}`, tabindex="-1", aria-labelledby=`modalEliminarLabel-${pedido._id}`, aria-hidden="true")
          div.modal-dialog
            div.modal-content
              div.modal-header
                h5.modal-title(id=`modalEliminarLabel-${pedido._id}`) Confirmar eliminación
                button.btn-close(type="button", data-bs-dismiss="modal", aria-label="Close")
              div.modal-body
                | ¿Seguro que deseas eliminar el pedido del cliente 
                strong #{pedido.id_cliente ? pedido.id_cliente.nombre + ' ' + pedido.id_cliente.apellido : 'sin cliente'}
                | ?
              div.modal-footer
                button.btn.btn-secondary(type="button", data-bs-dismiss="modal") Cancelar
                form(action=`/pedidos/${pedido._id}?_method=DELETE`, method="POST", style="display:inline")
                  button.btn.btn-danger(type="submit") Eliminar



    script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js")



script.
  document.addEventListener('DOMContentLoaded', () => {

  //- Ocultar el pedido finalizado de la lista de pedidos
    document.querySelectorAll('.btn-finalizar').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const id = e.target.dataset.id;
        try {
          const res = await fetch(`/pedidos/finalizar/${id}`, {
            method: 'PUT'
          });
          const data = await res.json();

          if (res.ok) {
            const li = e.target.closest('li.li-pedidos');
            if (li) li.remove();
          } else {
            alert('Error: ' + data.message);
          }
        } catch (err) {
          alert('Error al conectar con el servidor');
        }
      });
    });

    // Botón PREPARAR
    document.querySelectorAll('.btn-preparar').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const id = e.target.dataset.id;
        await fetch(`/pedidos/cambiar-estado/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ estado: 'preparando' })
        });
        location.reload();
      });
    });

    // Botón FINALIZAR
    document.querySelectorAll('.btn-finalizar').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const id = e.target.dataset.id;
        await fetch(`/pedidos/cambiar-estado/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ estado: 'finalizado' })
        });
        location.reload();
      });
    });

  });




