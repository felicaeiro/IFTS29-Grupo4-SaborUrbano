doctype html
html
    head
        title Nuevo Pedido
        link(rel="stylesheet", href="/css/styles.css")
    body
        h1 Editar pedido

        form.form-nuevoPedido(action=`/pedidos/${pedido.id}?_method=PUT`, method="POST")
            div.div-top

                div.div-element
                    label(for="fecha") Fecha:
                    - const fechaFormateada = pedido.fecha ? new Date(pedido.fecha).toISOString().substring(0, 10) : ''
                    input.form-input(type="date", name="fecha", required, value=fechaFormateada)

                div.div-element
                    label(for="id_cliente") Cliente:
                    select.form-input(name="id_cliente" required)
                        each c in clientes
                            if c._id.toString() === pedido.id_cliente._id.toString()
                                option(value=c._id, selected) #{c.nombre} #{c.apellido}
                            else
                                option(value=c._id) #{c.nombre} #{c.apellido}
                
                div.div-element
                    label(for="tipo") Tipo:
                    select.form-input(name="tipo")
                        option(value="Presencial" selected=(pedido.tipo === 'Presencial')) Presencial
                        option(value="Online" selected=(pedido.tipo === 'Online')) Online

                div.div-element
                    label(for="total") Total:
                    input.form-input#total(type="number", step="0.01", name="total", readonly, value=pedido.total ? pedido.total.toFixed(2) : 0)

                br


            div.div-bottom
                each p in productos
                    - const productoPedido = pedido.productos.find(pp => pp.producto._id.toString() === p._id.toString());
                    div.producto-item
                        div
                            input(
                                type="checkbox",
                                name="productos",
                                value=p._id,
                                data-precio=p.precio,
                                checked=productoPedido ? true : false
                            )
                            | #{p.nombre}
                        div
                            input.input-cantidad(
                                type="number",
                                name=`cantidades[${p._id}]`,
                                min="1",
                                value=productoPedido ? productoPedido.cantidad : 1,
                                class="cantidad-producto",
                                data-precio=p.precio,
                                disabled=productoPedido ? false : true
                            )


            div.form-div-btn
                button.btn(type="submit") Guardar cambios

        a(href="/pedidos")
            button.btn.btn-last Volver a la lista de pedidos




    //--------------------------------------------------------------------------
    script.
        document.addEventListener('DOMContentLoaded', () => {
            const totalInput = document.getElementById('total');

            // Actualizar el total en tiempo real
            function calcularTotal() {
                let total = 0;
                document.querySelectorAll('.producto-item').forEach(item => {
                        const checkbox = item.querySelector('input[type="checkbox"]');
                        const cantidadInput = item.querySelector('.cantidad-producto');
                    if (checkbox.checked) {
                        const precio = parseFloat(cantidadInput.dataset.precio);
                        const cantidad = parseInt(cantidadInput.value) || 0;
                        total += precio * cantidad;
                    }
            });
            totalInput.value = total.toFixed(2);
            }

            // Activar/desactivar cantidad segÃºn checkbox
            function toggleCantidad(checkbox) {
                const cantidadInput = checkbox.closest('.producto-item').querySelector('.cantidad-producto');
                cantidadInput.disabled = !checkbox.checked;
                calcularTotal();
            }

            document.querySelectorAll('.producto-item input[type="checkbox"]').forEach(checkbox => {
            if (checkbox.checked) toggleCantidad(checkbox);
                checkbox.addEventListener('change', e => toggleCantidad(e.target));
            });
            document.querySelectorAll('.cantidad-producto').forEach(input => {
            input.addEventListener('input', calcularTotal);
            });

            calcularTotal();
        });


